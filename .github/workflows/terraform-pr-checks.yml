name: Terraform PR Speculative Plan

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'

jobs:
  pr-plan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for AWS OIDC
      contents: read
      pull-requests: write # Required to post comments/summaries
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.13.5'

      # 1. Configure AWS Credentials (Read-Only/Plan Role)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Use your PLAN role here
          role-to-assume: 'arn:aws:iam::478468757808:role/KubeStock-Terraform-Plan-Role'
          aws-region: ${{ vars.AWS_REGION }}

      # 2. Terraform Format
      - name: Terraform Format
        working-directory: terraform/prod
        run: terraform fmt -check

      # 3. Generate tfvars (Securely)
      - name: Generate terraform.tfvars
        working-directory: terraform/prod
        run: |
          cat > terraform.tfvars <<EOF
          my_ip = "${{ vars.MY_IP }}"
          ssh_public_key_content = "${{ secrets.SSH_PUBLIC_KEY_CONTENT }}"
          EOF

      # 4. Init WITH Backend (Standard Init)
      - name: Terraform Init
        working-directory: terraform/prod
        run: terraform init
        # We DO connect to S3 here so we can read the current state.

      # 5. Validate
      - name: Terraform Validate
        working-directory: terraform/prod
        run: terraform validate

      # 6. Speculative Plan (The Magic Step)
      - name: Terraform Plan (Speculative)
        id: plan
        working-directory: terraform/prod
        run: terraform plan -lock=false -no-color | tee plan_output.txt

      # 7. Publish Plan to Job Summary (Easy to read)
      - name: Publish Plan to Job Summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/prod/plan_output.txt', 'utf8');
            const maxLen = 65000;
            const truncatedPlan = planOutput.length > maxLen ? 
              planOutput.substring(0, maxLen) + '\n\n... (truncated)' : 
              planOutput;
            
            await core.summary
              .addHeading('Terraform Speculative Plan')
              .addRaw('This plan was run with `-lock=false`. It predicts changes for this PR.')
              .addRaw('\n\n<details><summary>Click to expand full plan output</summary>\n\n')
              .addCodeBlock(truncatedPlan, 'terraform')
              .addRaw('\n</details>')
              .write();

      # 9. Comment plan on the PR
      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/prod/plan_output.txt', 'utf8');

            const body = `
              <details>
              <summary>Click to expand</summary>

              \`\`\`terraform
              ${plan.substring(0, 60000)}
              \`\`\`

              </details>
                    `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });


      # 10. Cleanup
      - name: Clean up sensitive files
        if: always()
        working-directory: terraform/prod
        run: |
          rm -f terraform.tfvars
          rm -f plan_output.txt