name: Terraform PR Speculative Plan

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'

env:
  AWS_REGION: ap-south-1
  SECRETS_PREFIX: kubestock/terraform

jobs:
  pr-plan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for AWS OIDC
      contents: read
      pull-requests: write # Required to post comments/summaries
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.13.5'

      # Configure AWS Credentials (Read-Only/Plan Role)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_PLAN_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Terraform Format
      - name: Terraform Format
        working-directory: terraform/prod
        run: terraform fmt -check

      # Init with backend
      - name: Terraform Init
        working-directory: terraform/prod
        run: terraform init

      # Validate
      - name: Terraform Validate
        working-directory: terraform/prod
        run: terraform validate

      # Generate tfvars from config file + secrets from AWS Secrets Manager
      - name: Generate terraform.tfvars
        working-directory: terraform/prod
        run: |
          # Start with the config file (non-secret values)
          cp terraform.tfvars.config terraform.tfvars
          
          # Fetch secrets from AWS Secrets Manager
          SECURITY=$(aws secretsmanager get-secret-value --secret-id ${{ env.SECRETS_PREFIX }}/security --query 'SecretString' --output text 2>/dev/null || echo '{}')
          DATABASE=$(aws secretsmanager get-secret-value --secret-id ${{ env.SECRETS_PREFIX }}/database --query 'SecretString' --output text 2>/dev/null || echo '{}')
          ASGARDEO=$(aws secretsmanager get-secret-value --secret-id ${{ env.SECRETS_PREFIX }}/asgardeo --query 'SecretString' --output text 2>/dev/null || echo '{}')
          SLACK=$(aws secretsmanager get-secret-value --secret-id ${{ env.SECRETS_PREFIX }}/alertmanager_slack --query 'SecretString' --output text 2>/dev/null || echo '{}')
          TEST_RUNNER=$(aws secretsmanager get-secret-value --secret-id ${{ env.SECRETS_PREFIX }}/test_runner --query 'SecretString' --output text 2>/dev/null || echo '{}')
          
          # Append secrets to tfvars
          cat >> terraform.tfvars <<EOF

# =============================================================================
# SECRETS (from AWS Secrets Manager)
# =============================================================================
          my_ip = "$(echo "$SECURITY" | jq -r '.my_ip')"
          ssh_public_key_content = "$(echo "$SECURITY" | jq -r '.ssh_public_key_content')"
          db_password = "$(echo "$DATABASE" | jq -r '.password')"
          db_username = "$(echo "$DATABASE" | jq -r '.username // "kubestock_admin"')"
          
          asgardeo_credentials = {
            production = {
              org_name                 = "$(echo "$ASGARDEO" | jq -r '.production.org_name')"
              base_url                 = "$(echo "$ASGARDEO" | jq -r '.production.base_url')"
              scim2_url                = "$(echo "$ASGARDEO" | jq -r '.production.scim2_url')"
              token_url                = "$(echo "$ASGARDEO" | jq -r '.production.token_url')"
              jwks_url                 = "$(echo "$ASGARDEO" | jq -r '.production.jwks_url')"
              issuer                   = "$(echo "$ASGARDEO" | jq -r '.production.issuer')"
              spa_client_id            = "$(echo "$ASGARDEO" | jq -r '.production.spa_client_id')"
              m2m_client_id            = "$(echo "$ASGARDEO" | jq -r '.production.m2m_client_id')"
              m2m_client_secret        = "$(echo "$ASGARDEO" | jq -r '.production.m2m_client_secret')"
              group_id_admin           = "$(echo "$ASGARDEO" | jq -r '.production.group_id_admin')"
              group_id_supplier        = "$(echo "$ASGARDEO" | jq -r '.production.group_id_supplier')"
              group_id_warehouse_staff = "$(echo "$ASGARDEO" | jq -r '.production.group_id_warehouse_staff')"
            }
            staging = {
              org_name                 = "$(echo "$ASGARDEO" | jq -r '.staging.org_name')"
              base_url                 = "$(echo "$ASGARDEO" | jq -r '.staging.base_url')"
              scim2_url                = "$(echo "$ASGARDEO" | jq -r '.staging.scim2_url')"
              token_url                = "$(echo "$ASGARDEO" | jq -r '.staging.token_url')"
              jwks_url                 = "$(echo "$ASGARDEO" | jq -r '.staging.jwks_url')"
              issuer                   = "$(echo "$ASGARDEO" | jq -r '.staging.issuer')"
              spa_client_id            = "$(echo "$ASGARDEO" | jq -r '.staging.spa_client_id')"
              m2m_client_id            = "$(echo "$ASGARDEO" | jq -r '.staging.m2m_client_id')"
              m2m_client_secret        = "$(echo "$ASGARDEO" | jq -r '.staging.m2m_client_secret')"
              group_id_admin           = "$(echo "$ASGARDEO" | jq -r '.staging.group_id_admin')"
              group_id_supplier        = "$(echo "$ASGARDEO" | jq -r '.staging.group_id_supplier')"
              group_id_warehouse_staff = "$(echo "$ASGARDEO" | jq -r '.staging.group_id_warehouse_staff')"
            }
          }
          
          alertmanager_slack_webhooks = {
            default_url  = "$(echo "$SLACK" | jq -r '.default_url')"
            critical_url = "$(echo "$SLACK" | jq -r '.critical_url')"
            warning_url  = "$(echo "$SLACK" | jq -r '.warning_url')"
          }
          
          test_runner_credentials = {
            client_id     = "$(echo "$TEST_RUNNER" | jq -r '.client_id')"
            client_secret = "$(echo "$TEST_RUNNER" | jq -r '.client_secret')"
            username      = "$(echo "$TEST_RUNNER" | jq -r '.username')"
            password      = "$(echo "$TEST_RUNNER" | jq -r '.password')"
          }
          EOF

      # Speculative Plan (no state lock)
      - name: Terraform Plan (Speculative)
        id: plan
        working-directory: terraform/prod
        run: terraform plan -lock=false -no-color | tee plan_output.txt

      # Publish Plan to Job Summary
      - name: Publish Plan to Job Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/prod/plan_output.txt', 'utf8');
            const maxLen = 65000;
            const truncatedPlan = planOutput.length > maxLen ? 
              planOutput.substring(0, maxLen) + '\n\n... (truncated)' : 
              planOutput;
            
            await core.summary
              .addHeading('Terraform Speculative Plan')
              .addRaw('This plan was run with `-lock=false`. It predicts changes for this PR.')
              .addRaw('\n\n<details><summary>Click to expand full plan output</summary>\n\n')
              .addCodeBlock(truncatedPlan, 'terraform')
              .addRaw('\n</details>')
              .write();

      # Comment plan on the PR
      - name: Comment Plan on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/prod/plan_output.txt', 'utf8');

            const body = `
              <details>
              <summary>Click to expand</summary>

              \`\`\`terraform
              ${plan.substring(0, 60000)}
              \`\`\`

              </details>
                    `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      # Cleanup
      - name: Clean up sensitive files
        if: always()
        working-directory: terraform/prod
        run: |
          rm -f terraform.tfvars
          rm -f plan_output.txt
