name: Terraform Manual Deployment

on:
  workflow_dispatch:

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      plan_ready: "true"
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.5"

      - name: Terraform Format Check
        working-directory: terraform/prod
        run: terraform fmt -check

      - name: Configure AWS Credentials (Plan Role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "arn:aws:iam::478468757808:role/KubeStock-Terraform-Plan-Role"
          aws-region: ${{ vars.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform/prod
        run: terraform init

      - name: Terraform Validate
        working-directory: terraform/prod
        run: terraform validate

      - name: Generate terraform.tfvars
        working-directory: terraform/prod
        run: |
          cat > terraform.tfvars <<EOF
          my_ip = "${{ secrets.MY_IP }}"
          ssh_public_key_content = "${{ secrets.SSH_PUBLIC_KEY_CONTENT }}"
          EOF

      - name: Terraform Plan and Save
        working-directory: terraform/prod
        run: terraform plan -input=false -out=tfplan -no-color | tee plan_output.txt

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-plan
          path: terraform/prod/tfplan

      - name: Upload Plan Output File
        uses: actions/upload-artifact@v4
        with:
          name: plan-output
          path: terraform/prod/plan_output.txt

      # âœ… PRINT FULL PLAN OUTPUT IN SUMMARY
      - name: Publish Plan to Summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/prod/plan_output.txt', 'utf8');

            const maxLen = 65000;
            const truncated = planOutput.length > maxLen
              ? planOutput.substring(0, maxLen) + "\n\n... (truncated)"
              : planOutput;

            await core.summary
              .addHeading('Terraform Plan (Production Manual Deployment)')
              .addRaw('This is the **Terraform plan output**. Review carefully before approving the production apply.')
              .addRaw('\n\n<details><summary>Click to expand full plan</summary>\n\n')
              .addCodeBlock(truncated, 'terraform')
              .addRaw('\n</details>')
              .write();

      - name: Cleanup sensitive files
        if: always()
        working-directory: terraform/prod
        run: |
          rm -f terraform.tfvars
          rm -f tfplan
          rm -f plan_output.txt

  apply:
    needs: plan
    # ðŸ‘‡ This pauses execution & requires manual approval from GitHub Environment
    environment: production
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.5"

      - name: Configure AWS Credentials (Apply Role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "arn:aws:iam::478468757808:role/KubeStock-Terraform-Apply-Role"
          aws-region: ${{ vars.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform/prod
        run: terraform init

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-plan
          path: terraform/prod/

      - name: Regenerate terraform.tfvars
        working-directory: terraform/prod
        run: |
          cat > terraform.tfvars <<EOF
          my_ip = "${{ secrets.MY_IP }}"
          ssh_public_key_content = "${{ secrets.SSH_PUBLIC_KEY_CONTENT }}"
          EOF

      - name: Terraform Apply
        working-directory: terraform/prod
        run: terraform apply -auto-approve tfplan

      - name: Cleanup sensitive files
        if: always()
        working-directory: terraform/prod
        run: |
          rm -f terraform.tfvars
          rm -f tfplan
